name: Sync out/ to Pages repo

# Trigger when the generator workflow completes successfully OR manually for testing
on:
  workflow_run:
    # include both the workflow "name" AND the workflow file name (safer)
    workflows:
      - "hourly-generate"        # workflow name (as set by `name:` in that workflow file)
      - "hourly-generate.yml"    # or the file name
      - "generate-artifacts"     # additional fallback if you named it differently
      - "generate-artifacts.yml"
    types:
      - completed

  # manual dispatch for quick testing
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: sync-out-to-pages
  cancel-in-progress: true

jobs:
  sync:
    # only run when the triggering workflow finished successfully
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Debug print event (for troubleshooting)
        run: |
          echo "EVENT_NAME: $GITHUB_EVENT_NAME"
          echo "PATH: $GITHUB_EVENT_PATH"
          echo "Event JSON:"
          jq . "$GITHUB_EVENT_PATH" || cat "$GITHUB_EVENT_PATH"

      - name: Checkout gh-boards (this repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure out/ exists
        run: |
          if [ ! -d out ]; then
            echo "No out/ directory present -> nothing to sync."
            exit 0
          fi

      - name: Prepare temporary workspace
        run: |
          rm -rf tmp-pages
          mkdir -p tmp-pages/gh-boards/out

      - name: Copy generated files into tmp workspace
        run: |
          rsync -av --delete out/ tmp-pages/gh-boards/out/

      - name: Checkout Pages repository
        uses: actions/checkout@v4
        with:
          repository: codefl0w/codefl0w.github.io
          path: pages-repo
          token: ${{ secrets.PAGES_REPO_TOKEN }}
          fetch-depth: 0

      - name: Sync into Pages repo (gh-boards/out)
        env:
          PAGES_DIR: pages-repo/gh-boards/out
        run: |
          set -e
          mkdir -p "$PAGES_DIR"
          rsync -av --delete tmp-pages/gh-boards/out/ "$PAGES_DIR/"
          cd pages-repo
          git config user.name "gh-boards-bot"
          git config user.email "actions@users.noreply.github.com"
          git add gh-boards/out || true
          if git diff --cached --quiet; then
            echo "No changes to publish"
          else
            git commit -m "chore(pages): publish gh-boards out/ (automated sync)"
            git push origin HEAD
          fi
