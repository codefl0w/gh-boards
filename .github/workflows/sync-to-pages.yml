name: Sync out/ to Pages repo

# Run every hour and allow manual runs for testing
on:
  schedule:
    - cron: '0 * * * *'   # top of every hour (UTC)
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: sync-out-to-pages
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-boards (this repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - print run info
        run: |
          echo "RUN_ID: $GITHUB_RUN_ID"
          echo "RUN_NUMBER: $GITHUB_RUN_NUMBER"
          echo "REF: $GITHUB_REF"

      - name: Ensure out/ exists
        run: |
          if [ ! -d out ]; then
            echo "No out/ directory present -> nothing to sync."
            exit 0
          fi

      - name: Prepare temporary workspace
        run: |
          rm -rf tmp-pages
          mkdir -p tmp-pages/gh-boards/out

      - name: Copy generated files into tmp workspace
        run: |
          rsync -av --delete out/ tmp-pages/gh-boards/out/

      - name: Checkout Pages repository
        uses: actions/checkout@v4
        with:
          repository: codefl0w/codefl0w.github.io
          path: pages-repo
          token: ${{ secrets.PAGES_REPO_TOKEN }}
          fetch-depth: 0

      - name: Sync into Pages repo (gh-boards/out)
        env:
          PAGES_DIR: pages-repo/gh-boards/out
        run: |
          set -e
          mkdir -p "$PAGES_DIR"
          rsync -av --delete tmp-pages/gh-boards/out/ "$PAGES_DIR/"
          cd pages-repo
          git config user.name "gh-boards-bot"
          git config user.email "actions@users.noreply.github.com"
          git add gh-boards/out || true
          if git diff --cached --quiet; then
            echo "No changes to publish"
          else
            git commit -m "chore(pages): publish gh-boards out/ (automated sync)"
            git push origin HEAD
          fi
