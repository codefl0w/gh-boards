name: Sync out/ to Pages repo

# Trigger when the generator workflow completes successfully
on:
  workflow_run:
    workflows: ["generate-artifacts"]     # <- exact name of the generator workflow
    types:
      - completed

permissions:
  contents: write

concurrency:
  group: sync-out-to-pages
  cancel-in-progress: true
jobs:
  sync:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-boards (this repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure out/ exists
        run: |
          if [ ! -d out ]; then
            echo "No out/ directory present -> nothing to sync."
            exit 0
          fi

      - name: Prepare temporary workspace
        run: |
          rm -rf tmp-pages
          mkdir -p tmp-pages/gh-boards/out

      - name: Copy generated files into tmp workspace
        run: |
          # Copy the entire out/ tree into tmp-pages/gh-boards/out/
          rsync -av --delete out/ tmp-pages/gh-boards/out/

      - name: Checkout Pages repository
        uses: actions/checkout@v4
        with:
          repository: codefl0w/codefl0w.github.io
          path: pages-repo
          token: ${{ secrets.PAGES_REPO_TOKEN }}
          fetch-depth: 0

      - name: Sync into Pages repo (gh-boards/out)
        env:
          PAGES_DIR: pages-repo/gh-boards/out
        run: |
          set -e
          # Ensure destination directory exists
          mkdir -p "$PAGES_DIR"
          # Copy files from tmp workspace into pages repo (overwrites)
          rsync -av --delete tmp-pages/gh-boards/out/ "$PAGES_DIR/"
          cd pages-repo
          git config user.name "gh-boards-bot"
          git config user.email "actions@users.noreply.github.com"
          git add gh-boards/out || true
          if git diff --cached --quiet; then
            echo "No changes to publish"
          else
            git commit -m "chore(pages): publish gh-boards out/ (automated sync)"
            git push origin HEAD
          fi
